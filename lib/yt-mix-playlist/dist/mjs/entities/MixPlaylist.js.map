{"version":3,"file":"MixPlaylist.js","sourceRoot":"","sources":["../../../src/entities/MixPlaylist.ts"],"names":[],"mappings":";;;;;;;;;;;;AAAA,OAAO,WAAW,MAAM,cAAc,CAAC;AACvC,OAAO,SAAS,MAAM,YAAY,CAAC;AAEnC,OAAO,EAAE,mBAAmB,EAAE,MAAM,aAAa,CAAC;AAClD,OAAO,oBAAoB,MAAM,2BAA2B,CAAC;AAC7D,OAAO,uBAAuB,MAAM,8BAA8B,CAAC;AACnE,OAAO,eAAe,MAAM,sBAAsB,CAAC;AAGnD,MAAM,CAAC,OAAO,OAAO,WAAY,SAAQ,oBAAoB;IAO3D,YAAY,IAAS,EAAE,OAAgB;QACrC,IAAI,CAAC,OAAO,EAAE,YAAY,EAAE;YAC1B,MAAM,KAAK,CAAC,qFAAqF,CAAC,CAAC;SACpG;QACD,KAAK,CAAC,IAAI,CAAC,CAAC;QANd,uCAAkB;QAQhB,IAAI,CAAC,KAAK,GAAG,OAAO,CAAC,YAAY,CAAC,KAAK,CAAC;QACxC,IAAI,CAAC,UAAU,GAAG,OAAO,CAAC,YAAY,CAAC,UAAU,CAAC;QAClD,IAAI,CAAC,UAAU,GAAG,OAAO,CAAC,YAAY,CAAC,UAAU,CAAC;QAClD,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC,YAAY,CAAC;QACtC,IAAI,CAAC,KAAK,GAAG,IAAI,CAAC,QAAQ,EAAE,MAAM,CAAC,CAAC,CAAoB,EAAE,CAAM,EAAE,EAAE;YAClE,MAAM,MAAM,GAAG,eAAe,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;YACxC,IAAI,MAAM,EAAE;gBACV,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;aAChB;YACD,OAAO,CAAC,CAAC;QACX,CAAC,EAAE,EAAE,CAAC,CAAC;QACP,uBAAA,IAAI,wBAAY,OAAO,MAAA,CAAC;IAC1B,CAAC;IAUD,MAAM,CAAC,KAAK,CAAC,KAAK,CAAC,OAAe,EAAE,OAA+E;QACjH,IAAI,OAAO,CAAC,MAAM,KAAK,EAAE,EAAE;YACzB,MAAM,IAAI,KAAK,CAAC,kBAAkB,CAAC,CAAC;SACrC;QAED,MAAM,OAAO,GAAY;YACvB,YAAY,EAAE,IAAI;YAClB,OAAO,EAAE;gBACP,EAAE,EAAE,OAAO,EAAE,EAAE;gBACf,EAAE,EAAE,OAAO,EAAE,EAAE;aAChB;YACD,OAAO,EAAE,WAAW,CAAC,SAAS,CAAC;SAChC,CAAC;QAEF,MAAM,YAAY,GAAG,OAAO,EAAE,6BAA6B;YACzD,CAAC,CAAC,MAAM,uBAAuB,CAAC,sBAAsB,CAAC,OAAO,CAAC;YAC/D,CAAC,CAAC,MAAM,uBAAuB,CAAC,KAAK,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;QAC1D,IAAI,YAAY,EAAE;YAChB,OAAO,CAAC,YAAY,GAAG,YAAY,CAAC;YACpC,OAAO,uBAAA,IAAI,gCAAS,MAAb,IAAI,EAAU,OAAO,EAAE,OAAO,CAAC,CAAC;SACxC;QAED,OAAO,IAAI,CAAC;IACd,CAAC;IAUD,KAAK,CAAC,MAAM,CAAC,MAAuB;QAClC,MAAM,OAAO,GAAG,OAAO,MAAM,KAAK,QAAQ,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC,EAAE,CAAC;QAC5E,OAAO,uBAAA,WAAW,gCAAS,MAApB,WAAW,EAAU,OAAO,EAAE,uBAAA,IAAI,4BAAS,CAAC,CAAC;IACtD,CAAC;IAED,KAAK,CAAC,WAAW;QACf,OAAO,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC;IACxB,CAAC;IAED,KAAK,CAAC,UAAU;QACd,OAAO,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC;IAC5C,CAAC;IAED,WAAW;QACT,OAAO,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC;IACvC,CAAC;IAED,sBAAsB;QACpB,OAAO,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC,EAAE,IAAI,CAAC,YAAY,CAAC,CAAC;IAChD,CAAC;IAED,qBAAqB;QACnB,OAAO,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,IAAI,CAAC,YAAY,GAAG,CAAC,CAAC,CAAC;IACjD,CAAC;CACF;yGAjEe,IAAS,EAAE,OAAgB;IACvC,IAAI,CAAC,IAAI,EAAE,UAAU,EAAE;QACrB,OAAO,IAAI,CAAC;KACb;IAED,OAAO,IAAI,WAAW,CAAC,IAAI,EAAE,OAAO,CAAC,CAAC;AACxC,CAAC,yBA2BM,KAAK,+BAAU,OAAe,EAAE,OAAgB;IACrD,MAAM,OAAO,GAAG,MAAM,mBAAmB,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;IAC5D,MAAM,YAAY,GAAG,OAAO,EAAE,QAAQ,EAAE,yBAAyB,EAAE,QAAQ,EAAE,QAAQ,CAAC;IACtF,OAAO,uBAAA,IAAI,8BAAO,MAAX,IAAI,EAAQ,YAAY,EAAE,OAAO,CAAC,IAAI,IAAI,CAAC;AACpD,CAAC","sourcesContent":["import fetchCookie from 'fetch-cookie';\r\nimport nodeFetch from 'node-fetch';\r\nimport Context from '../Context.js';\r\nimport { getWatchPageResults } from '../fetch.js';\r\nimport MixPlaylistBasicInfo from './MixPlaylistBasicInfo.js';\r\nimport MixPlaylistEndpointItem from './MixPlaylistEndpointItem.js';\r\nimport MixPlaylistItem from './MixPlaylistItem.js';\r\nimport Thumbnail from './Thumbnail.js';\r\n\r\nexport default class MixPlaylist extends MixPlaylistBasicInfo {\r\n  currentIndex: number;\r\n  items: MixPlaylistItem[];\r\n  videoCount: string;\r\n  thumbnails: Thumbnail[];\r\n  #context: Context;\r\n\r\n  constructor(data: any, context: Context) {\r\n    if (!context?.endpointItem) {\r\n      throw Error('Context missing or invalid. Make sure you are not calling the constructor directly.');\r\n    }\r\n    super(data);\r\n\r\n    this.title = context.endpointItem.title;\r\n    this.videoCount = context.endpointItem.videoCount;\r\n    this.thumbnails = context.endpointItem.thumbnails;\r\n    this.currentIndex = data.currentIndex;\r\n    this.items = data.contents?.reduce((r: MixPlaylistItem[], d: any) => {\r\n      const parsed = MixPlaylistItem.parse(d);\r\n      if (parsed) {\r\n        r.push(parsed);\r\n      }\r\n      return r;\r\n    }, []);\r\n    this.#context = context;\r\n  }\r\n\r\n  static #parse(data: any, context: Context): MixPlaylist | null {\r\n    if (!data?.playlistId) {\r\n      return null;\r\n    }\r\n\r\n    return new MixPlaylist(data, context);\r\n  }\r\n\r\n  static async fetch(videoId: string, options?: { gl?: string, hl?: string, preferInitialPlaylistGuessing?: boolean }): Promise<MixPlaylist | null> {\r\n    if (videoId.length !== 11) {\r\n      throw new Error('Invalid video ID');\r\n    }\r\n\r\n    const context: Context = {\r\n      endpointItem: null,\r\n      options: {\r\n        gl: options?.gl,\r\n        hl: options?.hl\r\n      },\r\n      fetchFn: fetchCookie(nodeFetch)\r\n    };\r\n\r\n    const endpointItem = options?.preferInitialPlaylistGuessing\r\n      ? await MixPlaylistEndpointItem.getGuessedEndpointItem(videoId)\r\n      : await MixPlaylistEndpointItem.fetch(videoId, context);\r\n    if (endpointItem) {\r\n      context.endpointItem = endpointItem;\r\n      return this.#doFetch(videoId, context);\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  static async #doFetch(videoId: string, context: Context): Promise<MixPlaylist | null> {\r\n    const results = await getWatchPageResults(videoId, context);\r\n    const playlistData = results?.contents?.twoColumnWatchNextResults?.playlist?.playlist;\r\n    return this.#parse(playlistData, context) || null;\r\n  }\r\n\r\n  async select(videoId: string): Promise<MixPlaylist | null>;\r\n  async select(index: number): Promise<MixPlaylist | null>;\r\n  async select(target: string | number): Promise<MixPlaylist | null> {\r\n    const videoId = typeof target === 'string' ? target : this.items[target].id;\r\n    return MixPlaylist.#doFetch(videoId, this.#context);\r\n  }\r\n\r\n  async selectFirst(): Promise<MixPlaylist | null> {\r\n    return this.select(0);\r\n  }\r\n\r\n  async selectLast(): Promise<MixPlaylist | null> {\r\n    return this.select(this.items.length - 1);\r\n  }\r\n\r\n  getSelected(): MixPlaylistItem {\r\n    return this.items[this.currentIndex];\r\n  }\r\n\r\n  getItemsBeforeSelected(): MixPlaylistItem[] {\r\n    return this.items.slice(0, this.currentIndex);\r\n  }\r\n\r\n  getItemsAfterSelected(): MixPlaylistItem[] {\r\n    return this.items.slice(this.currentIndex + 1);\r\n  }\r\n}\r\n"]}